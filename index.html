<html>
<head>
    <meta charset="UTF-8">
    <title></title>
    <style>
        body { margin: 0; }
        canvas { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <script src="threejs/three.js"></script>
    <script src="threejs/stats.min.js"></script>
    <script src="threejs/OrbitControls.js"></script>
    <script src="utils.js"></script>
    <script src="HexCoord.js"></script>
    <script src="MousePos.js"></script>
    <script src="fluid2.js"></script>
    <script src="Scene.js"></script>

    <script>


        var scene = new Scene();
        var mousePos = new MousePos(scene.renderer.domElement, scene.camera);


        scene.update = function (frame) {
            simulate(mousePos);
        };


        scene.computeColor = function(x, y, frame, state)
        {
            var time = frame / 60;

            // Get the fluid parameters
            var gx = Math.floor((x + 1) / 2 * WIDTH);
            var gy = Math.floor((y + 1) / 2 * HEIGHT);
            var p = p0(gx, gy);   // pressure
            var u = u0x(gx, gy);  // x-axis velocity
            var v = u0y(gx, gy);  // y-axis velocity

            state.vpos.x += u;
            state.vpos.y += v;

            // bounce off the walls
            if (state.vpos.x < -1) state.vpos.x = -1 - state.vpos.x % 1;
            if (state.vpos.x > 1) state.vpos.x = 1 - state.vpos.x % 1;
            if (state.vpos.y < -1) state.vpos.y = -1 - state.vpos.y % 1;
            if (state.vpos.y > 1) state.vpos.y = 1 - state.vpos.y % 1;

            state.vpos.lerp(new THREE.Vector2(x, y), 1/5);

            var c = plasma(state.vpos.x, state.vpos.y, time);
            //var c = colorRing(x + u, y + v, time);

            if (p < .5) p *= 2;
            //c.offsetHSL(0,0, -p);

            return c;
        }

        scene.start();


        function mandala(x, y, time)
        {
            var TAU = Math.PI * 2;
            var r = Math.sqrt(x*x + y*y);
            var a = Math.atan2(y, x);

            var c = new THREE.Color();
            var lol = (Math.abs(Math.abs(Math.sin(a * 3 + .1*time * TAU)) - r) +.5*time) % 1;
            c.setHSL(lol, 1, .5);
            return c;
        }

        function colorRing(x, y, time)
        {
            return new THREE.Color().setHSL(Math.sqrt(x*x + y*y), 1, .5);
        }

        function plasma(x, y, time)
        {
            // Scale variables to match original shader
            time /= 2;
            x *= 5;
            y *= 100;

            // Source: https://www.shadertoy.com/view/MdXGDH
            var color1, color2, color;

            color1 = (Math.sin(x * Math.sin(time * 3) + y * Math.cos(time * 3) * 0.02 + time * 3) + 1) / 2;

            var center_x = Math.sin(-time * 3);
            var center_y = Math.cos(-time * 3);

            var length = Math.sqrt((x - center_x) * (x - center_x) + (y - center_y) * (y - center_y));
            var color2 = (Math.cos(length * 0.03) + 1) / 2;

            var color = (color1 + color2) / 2;

            return new THREE.Color(
                    (Math.cos(Math.PI * color / 0.5 + time * 3) + 1) / 2,
                    (Math.sin(Math.PI * color / 0.5 + time * 3) + 1) / 2,
                    (Math.sin(+time * 3) + 1) / 2 );
        }


    </script>
</body>
</html>